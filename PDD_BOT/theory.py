from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputFile
from telegram.ext import ContextTypes
import os
import random


main_rules = [
    {
        "name": "üî∏ 1. –û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è",
        "description": f"- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ—Ä–æ–∂–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –æ–±—è–∑–∞–Ω—ã –∑–Ω–∞—Ç—å –∏ —Å–æ–±–ª—é–¥–∞—Ç—å –ü–î–î. - –ù–∞ –¥–æ—Ä–æ–≥–∞—Ö –¥–µ–π—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ. - –í–æ–¥–∏—Ç–µ–ª—å –æ–±—è–∑–∞–Ω –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º, –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å—Å—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¢–°. - –ó–∞–ø—Ä–µ—â–µ–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–ø—å—è–Ω–µ–Ω–∏—è, —É—Ç–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ –±–æ–ª–µ–∑–Ω–∏.",
    },
    {
        "name": "üî∏ 2. –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –≤–æ–¥–∏—Ç–µ–ª—è",
        "description":     "- –ò–º–µ—Ç—å –ø—Ä–∏ —Å–µ–±–µ:\n"
    "  - –í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ.\n"
    "  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –¢–°.\n"
    "  - –°—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –û–°–ê–ì–û.\n"
    "- –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–≤–∏–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:\n"
    "  - –ò—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å —Ç–æ—Ä–º–æ–∑–æ–≤, —Ä—É–ª–µ–≤–æ–≥–æ, —Å–≤–µ—Ç–∞ –∏ —Å–∏–≥–Ω–∞–ª–æ–≤.\n"
    "- –ü—Ä–∏ –î–¢–ü:\n"
    "  - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è, –≤–∫–ª—é—á–∏—Ç—å –∞–≤–∞—Ä–∏–π–∫—É, –≤—ã—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞–∫ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.\n"
    "  - –ù–µ —Ç—Ä–æ–≥–∞—Ç—å –¢–° –∏ –≤—ã–∑–≤–∞—Ç—å –ø–æ–ª–∏—Ü–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–µ –∏–ª–∏ —É—â–µ—Ä–±.",
    },
    {
        "name": "üî∏ 3. –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤",
        "description":     "- –ü—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –±—ã—Ç—å –ø—Ä–∏—Å—Ç—ë–≥–Ω—É—Ç—ã–º–∏ —Ä–µ–º–Ω—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.\n"
    "- –ù–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è –∏ –Ω–µ –º–µ—à–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¢–°.",
    },
    {
        "name": "üî∏ 4. –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–µ—à–µ—Ö–æ–¥–æ–≤",
        "description": "- –î–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç—Ä–æ—Ç—É–∞—Ä—É –∏–ª–∏ –æ–±–æ—á–∏–Ω–µ.\n"
    "- –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –¥–æ—Ä–æ–≥—É –ø–æ –ø–µ—Ä–µ—Ö–æ–¥—É –∏–ª–∏ –Ω–∞ –∑–µ–ª—ë–Ω—ã–π —Å–∏–≥–Ω–∞–ª —Å–≤–µ—Ç–æ—Ñ–æ—Ä–∞.\n"
    "- –ë—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–æ–µ–∑–∂—É—é —á–∞—Å—Ç—å –≤–Ω–µ–∑–∞–ø–Ω–æ.",
    },
    {
        "name": "üî∏ 5. –°–≤–µ—Ç–æ–≤–æ–π —Ä–µ–∂–∏–º\n",
        "description":     "- –§–∞—Ä—ã –±–ª–∏–∂–Ω–µ–≥–æ —Å–≤–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤–Ω–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ ‚Äî –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫.\n"
    "- –í —Ç—É–º–∞–Ω–µ, –¥–æ–∂–¥—å, —Å–Ω–µ–≥ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ç—É–º–∞–Ω–Ω—ã–µ —Ñ–∞—Ä—ã.\n"
    "- –ê–≤–∞—Ä–∏–π–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è:\n"
    "  - –ü—Ä–∏ –≤—ã–Ω—É–∂–¥–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤ –Ω–µ–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–º –º–µ—Å—Ç–µ.\n"
    "  - –ü—Ä–∏ –î–¢–ü.",
    },
    {
        "name": "üî∏ 6. –û–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏\n",
        "description": "- ¬´–ù–∞—á–∏–Ω–∞—é—â–∏–π –≤–æ–¥–∏—Ç–µ–ª—å¬ª ‚Äî –ø—Ä–∏ —Å—Ç–∞–∂–µ –º–µ–Ω–µ–µ 2 –ª–µ—Ç.\n"
    "- ¬´–®–∏–ø—ã¬ª ‚Äî –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.\n"
    "- ¬´–ò–Ω–≤–∞–ª–∏–¥¬ª ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",
    },
    {
        "name": "üî∏ 7. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–≤–æ–∑–æ–∫\n",
        "description":     "- –ü–µ—Ä–µ–≤–æ–∑–∫–∞ –¥–µ—Ç–µ–π:\n"
    "  - –î–æ 7 –ª–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ –≤ –∞–≤—Ç–æ–∫—Ä–µ—Å–ª–µ.\n"
    "  - –û—Ç 7 –¥–æ 12 ‚Äî –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–µ–º–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ –∑–∞–¥–Ω–µ–º —Å–∏–¥–µ–Ω—å–µ.\n"
    "- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–µ—Ä–µ–≤–æ–∑–∏—Ç—å –ª—é–¥–µ–π –≤ –Ω–µ–ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∏–ª–∏ –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏.",
    },
]

pages_main_rules = [
    "üî∏ 4. –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–µ—à–µ—Ö–æ–¥–æ–≤\n"
    "- –î–≤–∏–≥–∞—Ç—å—Å—è –ø–æ —Ç—Ä–æ—Ç—É–∞—Ä—É –∏–ª–∏ –æ–±–æ—á–∏–Ω–µ.\n"
    "- –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –¥–æ—Ä–æ–≥—É –ø–æ –ø–µ—Ä–µ—Ö–æ–¥—É –∏–ª–∏ –Ω–∞ –∑–µ–ª—ë–Ω—ã–π —Å–∏–≥–Ω–∞–ª —Å–≤–µ—Ç–æ—Ñ–æ—Ä–∞.\n"
    "- –ë—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–æ–µ–∑–∂—É—é —á–∞—Å—Ç—å –≤–Ω–µ–∑–∞–ø–Ω–æ.",

    "üî∏ 5. –°–≤–µ—Ç–æ–≤–æ–π —Ä–µ–∂–∏–º\n"
    "- –§–∞—Ä—ã –±–ª–∏–∂–Ω–µ–≥–æ —Å–≤–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤–Ω–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ ‚Äî –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫.\n"
    "- –í —Ç—É–º–∞–Ω–µ, –¥–æ–∂–¥—å, —Å–Ω–µ–≥ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤–æ—Ç—É–º–∞–Ω–Ω—ã–µ —Ñ–∞—Ä—ã.\n"
    "- –ê–≤–∞—Ä–∏–π–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è:\n"
    "  - –ü—Ä–∏ –≤—ã–Ω—É–∂–¥–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤ –Ω–µ–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–º –º–µ—Å—Ç–µ.\n"
    "  - –ü—Ä–∏ –î–¢–ü.",

    "üî∏ 6. –û–ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏\n"
    "- ¬´–ù–∞—á–∏–Ω–∞—é—â–∏–π –≤–æ–¥–∏—Ç–µ–ª—å¬ª ‚Äî –ø—Ä–∏ —Å—Ç–∞–∂–µ –º–µ–Ω–µ–µ 2 –ª–µ—Ç.\n"
    "- ¬´–®–∏–ø—ã¬ª ‚Äî –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.\n"
    "- ¬´–ò–Ω–≤–∞–ª–∏–¥¬ª ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",

    "üî∏ 7. –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–≤–æ–∑–æ–∫\n"
    "- –ü–µ—Ä–µ–≤–æ–∑–∫–∞ –¥–µ—Ç–µ–π:\n"
    "  - –î–æ 7 –ª–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ –≤ –∞–≤—Ç–æ–∫—Ä–µ—Å–ª–µ.\n"
    "  - –û—Ç 7 –¥–æ 12 ‚Äî –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–µ–º–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ –∑–∞–¥–Ω–µ–º —Å–∏–¥–µ–Ω—å–µ.\n"
    "- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–µ—Ä–µ–≤–æ–∑–∏—Ç—å –ª—é–¥–µ–π –≤ –Ω–µ–ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∏–ª–∏ –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏.",
]


from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import CallbackQueryHandler, ContextTypes
from theory import pages_main_rules

def get_theory_text(theory, index, total):
    return f"*{theory['name']}*\n\n{theory['description']}\n\n–¢–µ–æ—Ä–∏—è {index + 1} –∏–∑ {total}"

user_message_ids = {}


def get_theory_keyboard(index, total):
    buttons = []

    if index > 0:
        buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"theory_{index - 1}"))

    if index < total - 1:
        buttons.append(InlineKeyboardButton("‚û°Ô∏è –î–∞–ª–µ–µ", callback_data=f"theory_{index + 1}"))

    if index == total - 1:
        buttons.append(InlineKeyboardButton("–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ—Å—Ç—É", callback_data=f"start_test"))

    # –ö–Ω–æ–ø–∫–∞ "–í –º–µ–Ω—é"
    buttons.append(InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data="back_to_topics"))

    return InlineKeyboardMarkup([buttons])


async def show_theory(update, context: ContextTypes.DEFAULT_TYPE, index: int):
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id

    if index < 0 or index >= len(main_rules):
        await context.bot.send_message(chat_id, "‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã.")
        return

    theory = main_rules[index]
    text = get_theory_text(theory, index, len(main_rules))
    keyboard = get_theory_keyboard(index, len(main_rules))

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –±—ã–ª–æ
    if user_id in user_message_ids:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=user_message_ids[user_id])
        except:
            pass

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    sent = await context.bot.send_message(
        chat_id=chat_id,
        text=text,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )

    user_message_ids[user_id] = sent.message_id


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫: "–î–∞–ª–µ–µ", "–ù–∞–∑–∞–¥", "–í –º–µ–Ω—é"
async def handle_theory_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data.startswith("theory_"):
        try:
            index = int(data.split("_")[1])
            await show_theory(update, context, index)
        except ValueError:
            await query.edit_message_text("–û—à–∏–±–∫–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.")
    elif data == "back_to_topics":
        # –í–æ–∑–≤—Ä–∞—Ç –≤ —Å–ø–∏—Å–æ–∫ —Ç–µ–º (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤—ã–∑–æ–≤ —Å–≤–æ–µ–π —Ñ—É–Ω–∫—Ü–∏–∏)
        from main import get_topics_keyboard
        chat_id = query.message.chat_id
        await context.bot.send_message(
            chat_id=chat_id,
            text="üìö –í–æ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ–º:",
            reply_markup=get_topics_keyboard()
        )